# Story 1.1: Policy Storage Service Integration

## Status
Draft

## Story
**As a** enterprise platform admin,
**I want** to store and manage visual trust policies through a robust API service,
**so that** I can create, version, and deploy trust policies for my organization's agents.

## Acceptance Criteria
1. Policy Storage API provides full CRUD operations for visual policies
2. Policies are scoped by organization/tenant with proper isolation
3. Policy versioning system tracks changes and allows rollback
4. Database schema supports all policy metadata (status, tags, categories)
5. Integration with PostgreSQL database is working and tested
6. API endpoints are secured and validated
7. Policy validation occurs before storage using the schema
8. Audit logging captures all policy storage operations

## Tasks / Subtasks
- [ ] Task 1: Complete Policy Storage Database Integration (AC: 1, 5)
  - [ ] Verify PostgreSQL schema for visual_policies table exists
  - [ ] Test database connection and CRUD operations
  - [ ] Implement proper error handling for database operations
  
- [ ] Task 2: Implement Policy Storage API Endpoints (AC: 1, 6)
  - [ ] Create REST API endpoints for policy CRUD operations
  - [ ] Add request validation and authentication middleware
  - [ ] Implement organization-scoped access control
  
- [ ] Task 3: Add Policy Versioning System (AC: 3)
  - [ ] Implement version tracking in database schema
  - [ ] Add version comparison and rollback functionality
  - [ ] Create version history API endpoints
  
- [ ] Task 4: Integration Testing (AC: 4, 7, 8)
  - [ ] Write comprehensive unit tests for storage service
  - [ ] Test policy validation integration
  - [ ] Verify audit logging for all operations
  - [ ] Test multi-tenant isolation

## Dev Notes

### Previous Story Insights
This is the first story in the Visual Trust Policy Editor implementation. The policy schema work (VPE-1.1) has been completed and is available in `packages/shared/src/policy/visual-policy-schema.ts`.

### Data Models
**Policy Storage Schema** [Source: packages/shared/src/policy/visual-policy-storage.ts]
- `ATPVisualPolicy` interface with comprehensive metadata support
- `PolicySearchFilters` for querying and filtering policies
- `PolicyDeployment` interface for tracking policy deployments
- Multi-tenant organization scoping with `organizationId` field

**Database Schema** [Source: visual-policy-storage.ts#L121]
- PostgreSQL table: `atp_permissions.visual_policies`
- Stored procedure: `atp_permissions.create_visual_policy()`
- JSON document storage for policy definitions
- Support for categories, tags, status tracking

### API Specifications
**Policy Storage Endpoints** [Source: ATP_Trust_Editor_Architecture.md]
- POST /policies - Create new policy
- GET /policies/:id - Retrieve policy by ID
- PUT /policies/:id - Update existing policy
- DELETE /policies/:id - Archive/delete policy
- GET /policies - List policies with filtering

**Authentication Requirements** [Source: ATP_Trust_Editor_Architecture.md]
- Admin-only access for policy management
- Organization-scoped access control
- Input validation and sanitization required

### Component Specifications
**Policy Storage Service** [Source: packages/shared/src/policy/visual-policy-storage.ts]
- Extends `BaseStorage` class for database operations
- Implements comprehensive CRUD operations
- Includes policy validation using schema
- Supports organization limits and multi-tenancy
- Built-in audit logging integration

### File Locations
Based on existing project structure:
- Policy storage implementation: `packages/shared/src/policy/visual-policy-storage.ts` (exists)
- Database schema: `packages/shared/src/database/schemas/visual-policy-schema.sql` (needs creation)
- API endpoints: `packages/permission-service/src/controllers/policy-controller.ts` (needs creation)
- Tests: `packages/shared/src/policy/__tests__/visual-policy-storage.test.ts` (exists, needs completion)

### Testing Requirements
**Testing Strategy** [Source: docs/architecture.md#testing]
- Unit tests for all CRUD operations
- Integration tests with PostgreSQL database
- Multi-tenant isolation testing
- Policy validation testing
- Audit logging verification
- Performance testing for policy queries

**Test File Locations**
- Unit tests: `packages/shared/src/policy/__tests__/`
- Integration tests: `packages/permission-service/src/__tests__/`
- Test framework: Jest (as configured in project)

### Technical Constraints
**Database Requirements** [Source: docs/architecture.md#storage]
- PostgreSQL as primary database
- JSON document storage for policy definitions
- ACID compliance for policy operations
- Support for concurrent access

**Performance Considerations** [Source: docs/architecture.md#performance]
- Policy retrieval should be < 15ms
- Support for high-throughput policy queries
- Efficient indexing on organization_id and policy_id

**Security Requirements** [Source: ATP_Trust_Editor_Architecture.md#security]
- Input validation and sanitization
- Authenticated admin-only access
- Sandboxed policy execution
- Audit trail for all operations

### Project Structure Notes
The policy storage service integrates with the existing ATP microservices architecture:
- Shared policy utilities in `packages/shared/src/policy/`
- Permission service handles policy API endpoints
- Audit logger captures all policy operations
- RPC Gateway provides secure access to policy APIs

## Testing

### Testing Standards
**Test File Location**: `packages/shared/src/policy/__tests__/` and `packages/permission-service/src/__tests__/`

**Testing Framework**: Jest with TypeScript support

**Test Categories Required**:
- Unit tests for PolicyStorage class methods
- Integration tests with PostgreSQL database
- API endpoint testing with authentication
- Multi-tenant isolation verification
- Policy validation and error handling
- Audit logging integration tests

**Coverage Requirements**: Minimum 90% code coverage for policy storage functionality

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-23 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here after implementation*